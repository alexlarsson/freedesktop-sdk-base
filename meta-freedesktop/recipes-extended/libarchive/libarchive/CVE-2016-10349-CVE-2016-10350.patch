From a3c028d8172aacbe221bcbcc12763d6ad7d17a40 Mon Sep 17 00:00:00 2001
From: Tuomas Katila <tuomas.katila@intel.com>
Date: Wed, 24 May 2017 08:40:43 +0300
Subject: [PATCH] CVE-2016-10349 & CVE-2016-10350

https://github.com/libarchive/libarchive/issues/835
https://github.com/libarchive/libarchive/issues/834
https://github.com/libarchive/libarchive/commit/88eb9e1d73fef46f04677c25b1697b8e25777ed3?diff=unified

Signed-off-by: Tuomas Katila <tuomas.katila@intel.com>
---
 libarchive/archive_read_support_format_cab.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/libarchive/archive_read_support_format_cab.c b/libarchive/archive_read_support_format_cab.c
index fc70684..099f4a8 100644
--- a/libarchive/archive_read_support_format_cab.c
+++ b/libarchive/archive_read_support_format_cab.c
@@ -645,12 +645,13 @@ cab_read_header(struct archive_read *a)
 	cab = (struct cab *)(a->format->data);
 	if (cab->found_header == 0 &&
 	    p[0] == 'M' && p[1] == 'Z') {
-		/* This is an executable?  Must be self-extracting... 	*/
+		/* This is an executable?  Must be self-extracting... */
 		err = cab_skip_sfx(a);
 		if (err < ARCHIVE_WARN)
 			return (err);
 
-		if ((p = __archive_read_ahead(a, sizeof(*p), NULL)) == NULL)
+		/* Re-read header after processing the SFX. */
+		if ((p = __archive_read_ahead(a, 42, NULL)) == NULL)
 			return (truncated_error(a));
 	}
 
-- 
2.7.4

